name: CI

on:
  push:
    branches: [ main, dev/** ]
  pull_request:
    branches: [ main, dev/** ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: ${{ github.workspace }}/vcpkg
        vcpkgGitCommitId: 'b3224e69953d14df95e6e37c5cf3f49e6c7b3f5e'  # Pin to a stable commit

    - name: Configure CMake (Debug)
      run: |
        cmake -S Mods/NakamaX4Client/cpp -B build `
              -DCMAKE_BUILD_TYPE=Debug `
              -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

    - name: Build (Debug)
      run: cmake --build build --config Debug --parallel

    - name: Configure CMake (Release)
      run: |
        cmake -S Mods/NakamaX4Client/cpp -B build-release `
              -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

    - name: Build (Release)
      run: cmake --build build-release --config Release --parallel

  code-quality:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: ${{ github.workspace }}/vcpkg
        vcpkgGitCommitId: 'b3224e69953d14df95e6e37c5cf3f49e6c7b3f5e'  # Pin to a stable commit

    - name: Install clang-format
      run: choco install llvm --yes

    - name: Check code formatting
      run: |
        $files = Get-ChildItem -Path Mods/NakamaX4Client/cpp/src -Include *.cpp,*.h -Recurse
        foreach ($file in $files) {
          clang-format --dry-run --Werror --style=file $file.FullName
        }

    - name: Run cppcheck
      uses: docker://ghcr.io/jidicula/cppcheck-action:latest
      with:
        args: '--enable=all --std=c++20 --language=c++ --platform=win64 Mods/NakamaX4Client/cpp/src'